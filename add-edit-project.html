<!DOCTYPE html>
<html lang="en">
<head>
    <title>Add/Edit Project - Lumetra</title>
    <link rel="stylesheet" href="css/style.css">
    <style>/* Admin form styles */</style>
</head>
<body>
    <div class="dashboard-container" style="max-width:800px; margin: 2rem auto;">
        <h2 id="form-title">Add New Project</h2>
        <form id="project-form">
            <!-- Form fields: title, category, description, image-upload -->
            <div class="form-group"><label>Title</label><input type="text" id="title" required></div>
            <div class="form-group"><label>Category</label><input type="text" id="category" required></div>
            <div class="form-group"><label>Description</label><textarea id="description" rows="5" required></textarea></div>
            <div class="form-group"><label>Project Image</label><input type="file" id="image-upload"></div>
            <img id="current-image" src="" width="200" style="display:none; margin-bottom:1rem; border-radius: 8px;">
            <p id="upload-status" style="font-weight: 600;"></p>
            <button type="submit" class="cta-button">Save Project</button>
            <a href="manage-portfolio.html" style="margin-left:1rem;">Cancel</a>
        </form>
    </div>

    <!-- SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <!-- Central Config (provides db, auth, and imgbbApiKey) -->
    <script src="js/admin-firebase.js"></script>

    <!-- Page-specific script -->
    <script>
        let currentProjectId = null;
        let currentImageUrl = null;

        document.addEventListener("DOMContentLoaded", () => {
            const params = new URLSearchParams(window.location.search);
            currentProjectId = params.get('id');
            if (currentProjectId) {
                document.getElementById('form-title').textContent = "Edit Project";
                db.collection("portfolio").doc(currentProjectId).get().then(doc => {
                    const project = doc.data();
                    document.getElementById('title').value = project.title;
                    document.getElementById('category').value = project.category;
                    document.getElementById('description').value = project.description;
                    if (project.image) {
                        currentImageUrl = project.image;
                        document.getElementById('current-image').src = currentImageUrl;
                        document.getElementById('current-image').style.display = 'block';
                    }
                });
            }
        });

        document.getElementById('project-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const imageFile = document.getElementById('image-upload').files[0];
            const statusP = document.getElementById('upload-status');
            const submitButton = e.target.querySelector('button[type="submit"]');
            submitButton.disabled = true;

            // The imgbbApiKey variable now comes globally from admin-firebase.js
            if (imgbbApiKey === "YOUR_IMGBB_API_KEY") {
                statusP.textContent = "Error: ImgBB API Key is not set in admin-firebase.js";
                submitButton.disabled = false;
                return;
            }

            if (imageFile) {
                statusP.textContent = 'Uploading image...';
                const formData = new FormData();
                formData.append('image', imageFile);
                fetch(`https://api.imgbb.com/1/upload?key=${imgbbApiKey}`, { method: 'POST', body: formData })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        currentImageUrl = result.data.url;
                        saveProjectToFirestore();
                    } else { throw new Error(result.error.message); }
                })
                .catch(error => { statusP.textContent = `Upload failed: ${error.message}`; submitButton.disabled = false; });
            } else {
                saveProjectToFirestore();
            }
        });

        function saveProjectToFirestore() {
            const projectData = {
                title: document.getElementById('title').value,
                category: document.getElementById('category').value,
                description: document.getElementById('description').value,
                image: currentImageUrl
            };
            if (!projectData.image) {
                alert("Please select an image.");
                document.querySelector('button[type="submit"]').disabled = false;
                return;
            }
            const operation = currentProjectId ? db.collection("portfolio").doc(currentProjectId).update(projectData) : db.collection("portfolio").add(projectData);
            operation.then(() => { alert('Saved!'); window.location.href = 'manage-portfolio.html'; });
        }
    </script>
</body>
</html>
